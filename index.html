<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Movie Recommender System</title>
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <style>
        body {
            margin: 0;
        }
    </style>
</head>
<div id="app">
    <el-menu mode="horizontal" default-active="1" background-color="#545c64"
             text-color="#fff"
             active-text-color="#ffd04b">
        <el-menu-item index="1">Movie Recommender System</el-menu-item>
    </el-menu>
    <el-container>
        <el-main>
            <h2>First Round Recommendation</h2>
            <div v-if="recommended.length">
                <p>According to your rated movies we find 12 similar movies for you</p>
                <p>Please give your rate for each movie. Second round recommendation will be generated based on these rate, thank you!</p>
            </div>
            <el-row :gutter="20">
                <el-col :span="4" v-for="o in recommended" :key="o.movie_id" :offset="0">
                    <el-card :body-style="{ padding: '0px' }"
                             style="margin-top:15px;height:400px;overflow:auto;position:relative">
                        <el-image
                                style="width: 100%;height:240px;"
                                :src="o.poster_url"
                                fit="cover"></el-image>
                        <h4 style="padding:0 10px;margin:0">{{o.movie_title}}</h4>
                        <h5 style="padding:0 10px;margin:0">Release year:{{ o.release_year }}</h5>
                        <h5 style="padding:0 10px;margin:0">Your rate:</h5>
                        <el-rate v-model="o.feedback" style="padding:10px 10px;" @change="storeFeedback(o)"></el-rate>
                        <!-- <el-button type="danger" plain style="position:absolute;bottom:10px;right:10px" @click="liked_btn(o)">
                            <i class="el-icon-medal el-icon--left"></i>Like
                        </el-button> -->
                    </el-card>
                </el-col>
            </el-row>
            <p></p>
            <el-button type="danger" plain @click="confirmFeedback" :disabled="confirmFeedback_show">
                <i class="el-icon-check el-icon--left"></i>Submit your rate of first round recommendation 
            </el-button>
            <!-- 2nd round recommendation -->
            <h2>Second Round Recommendation</h2>
            <div v-if="second_recommended.length">
                <p>We've found 12 movies that are similar to the ones you rated above, you might like them better</p>
                <p>Again, please give your rate for these recommend movies, This will help us to develop better recommend system in the future, thank you!</p>
            </div>
            <el-row :gutter="20">
                <el-col :span="4" v-for="o in second_recommended" :key="o.movie_id" :offset="0">
                    <el-card :body-style="{ padding: '0px' }"
                             style="margin-top:15px;height:400px;overflow:auto;position:relative">
                        <el-image
                                style="width: 100%;height:240px;"
                                :src="o.poster_url"
                                fit="cover"></el-image>
                        <h4 style="padding:0 10px;margin:0">{{o.movie_title}}</h4>
                        <h5 style="padding:0 10px;margin:0">Release year:{{ o.release_year }}</h5>
                        <h5 style="padding:0 10px;margin:0">Your rate:</h5>
                        <el-rate v-model="o.feedback" style="padding:10px 10px;" @change="store2ndFeedback(o)"></el-rate>
                    </el-card>
                </el-col>
            </el-row>
            <!-- user login -->
            <el-dialog 
                    title="Information Collection"
                    :visible="userLogin"
                    width="60%"
                    :show-close="false"
            >
                <el-input v-model="username" placeholder="Please input your name"></el-input>
                <span slot="footer" class="dialog-footer">
                    <el-button type="danger" @click="step0" plain :disabled="step0_show"
                               style="min-width:128px">Next</el-button>
                </span>
            </el-dialog>

            <!--  cold start -->
            <el-dialog
                    title="Please choose any genre you're interested in."
                    :visible="dialog0"
                    width="60%"
                    :show-close="false"
            >
                <span>Multiple answers are possible.</span>
                <el-checkbox-group v-model="selected_genre" style="margin-top:20px">
                    <el-checkbox :label=item border v-for="(item, index) in genre" :key="index"
                                 style="margin-top:20px; margin-left: 0px"></el-checkbox>
                </el-checkbox-group>
                <span slot="footer" class="dialog-footer">
                    <el-button type="danger" @click="step1" plain :disabled="step1_show"
                               style="min-width:128px">Next</el-button>
                </span>
            </el-dialog>
            <!--  1st round recommendation -->
            <el-dialog
                    title="Please rate the following movies."
                    :visible="dialog1"
                    width="80%"
                    :show-close="false"
            >
                <el-row :gutter="20">
                    <el-col :span="4" v-for="o in movies" :key="o.movie_id" :offset="0">
                        <el-card :body-style="{ padding: '0px' }" style="margin-top:15px;height:368px;overflow:auto">
                            <el-image
                                    style="width: 100%;height:240px;"
                                    :src="o.poster_url"
                                    fit="cover"></el-image>
                            <h4 style="padding:0 10px;margin:0">{{o.movie_title}}</h4>
                            <h5 style="padding:0 10px;margin:0">Release year:{{ o.release_year }}</h5>
                            <el-rate v-model="o.score" style="padding:10px 10px;"></el-rate>
                        </el-card>
                    </el-col>
                </el-row>
                <span slot="footer" class="dialog-footer">
                    <el-button type="danger" @click="step2" plain :disabled="step2_show"
                               style="width:128px">Next</el-button>
                </span>
            </el-dialog>

        </el-main>

    </el-container>
</div>
<body>
<!-- import Vue before Element -->
<script src="https://unpkg.com/vue@2.6.14/dist/vue.js"></script>
<!-- import JavaScript -->
<script src="https://unpkg.com/element-ui/lib/index.js"></script>
<script src="https://unpkg.com/element-ui/lib/umd/locale/en.js"></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script>
    ELEMENT.locale(ELEMENT.lang.en)
    new Vue({
        el: '#app',
        data: function () {
            return {
                baseurl: 'http://127.0.0.1:8000',
                username: '',
                genre: [],
                selected_genre: [],
                movies: [], // random moives for cold start
                rated_movies: [], // rated movies for 1st round recommendation
                recommended: [],
                allFeedback: {}, // user's first feedback
                second_recommended: [],
                userLogin: true,
                dialog0: false,
                dialog1: false,
                confirmFeedback_show: true,
                iconClasses: ['icon-rate-face-1', 'icon-rate-face-2', 'icon-rate-face-3'],
                checkboxGroup1: [],
                value: 2
            }
        },
        methods: {
            step0: function(){
                axios.post(this.baseurl + "/api/login", [this.username]).then((res) => {
                    if (!res.data["result"]){
                        alert("Name is Duplicated! Input again.")
                    } else{
                        this.userLogin = false;
                        this.dialog0 = true;
                    }
                })
            },
            step1: function () {
                axios.post(this.baseurl + "/api/movies", this.selected_genre).then((res) => {
                    //console.log(res);
                    this.movies = res.data;
                    console.log(typeof this.movies);
                    if (this.movies.length === 18) {
                        this.dialog0 = false;
                        this.dialog1 = true;
                    } else {
                        this.$message({
                            showClose: true,
                            message: 'Error'
                        });
                    }
                })
            },
            step2: function () {
                console.log(this.movies);
                // only send the rated movies 
                for(var movie of this.movies){
                    if(movie['score'] != 0){
                        this.rated_movies.push(movie)
                    }
                }
                axios.post(this.baseurl + "/api/recommend", [this.username, this.rated_movies]).then((res) => {
                    // console.log(res.data)
                    this.recommended = res.data;
                    if (this.recommended.length > 0) {
                        this.dialog1 = false;
                    } else {
                        this.$message({
                            showClose: true,
                            message: 'Error'
                        });
                    }
                });
            },
            // temporarily store user's feedback
            storeFeedback:function(movie){
                // this.allFeedback.set(movie.movie_id, movie.feedback)
                this.allFeedback[movie.movie_id] = movie.feedback;
                console.log(Object.keys(this.allFeedback).length);
                if(Object.keys(this.allFeedback).length>=1){
                    this.confirmFeedback_show = false;
                }
            },
            // 
            store2ndFeedback: function(movie){

            },
            // store all user's feedback and get 2nd recommendation
            confirmFeedback: function(){
                console.log(JSON.stringify(this.allFeedback));
                // store all user's feedback to local users.csv
                axios.post(this.baseurl + "/api/fisrt_feedback", [this.username, this.allFeedback]).then((res=>{
                    console.log(JSON.stringify(res.data));
                }));
                // get 2nd recommend
                axios.post(this.baseurl + '/api/add_recommend', [this.username, this.allFeedback]).then((res) => {
                    console.log(res.data);
                    // that.recommended.push.apply(that.recommended,res.data);
                    // that.liked.push.apply(that.liked,res.data);
                    this.second_recommended = res.data;
                    console.log(this.second_recommended);
                    this.confirmFeedback_show = true;
                })
                
            },
            // liked_btn:function(movie){
            //     let that = this;
            //     this.liked.push(movie);
            //     this.recommended.splice(this.recommended.findIndex(item => item.movie_id === movie.movie_id), 1);
            //     axios.get(this.baseurl+'/api/add_recommend/'+movie.movie_id).then((res) =>{
            //         console.log(res.data);
            //         // that.recommended.push.apply(that.recommended,res.data);
            //         that.liked.push.apply(that.liked,res.data);
            //     })
            // }
        },
        mounted: function () {
            axios.get(this.baseurl + "/api/genre").then((res) => {
                this.genre = res.data['genre'];
            })
        },
        computed: {
            step0_show: function () {
                if (this.username == '') {
                    return true;
                } else {
                    return false;
                }
            },
            step1_show: function () {
                if (this.selected_genre.length > 0) {
                    return false;
                } else {
                    return true;
                }
            },
            step2_show: function () {
                let scores = 0;
                for (let i of this.movies) {
                    if (i['score'] > 0) {
                        scores++
                    }
                }
                console.log(scores);
                if (scores >= 1) {
                    return false;
                } else {
                    return true
                }
            },
            
        }
    })
</script>
</body>
</html>
